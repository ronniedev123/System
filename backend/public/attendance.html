<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance</title>
<link rel="stylesheet" href="css/styles.css">

<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
th { background: #f2f2f2; }
button { padding: 5px 10px; cursor: pointer; }
#logoutBtn { float: right; background-color: #f44336; color: white; border: none; border-radius: 5px; }

.suggestion-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
.suggestion-item:hover {
    background-color: #f0f0f0;
}

.clickable-cell { cursor: pointer; user-select: none; }
.clickable-cell:hover { opacity: 0.8; }

th { background-color: #2196F3; color: white; font-weight: bold; }
tr:nth-child(even) { background-color: #f9f9f9; }
</style>
</head>
<body>

<button onclick="window.location.href='dashboard.html'" 
style="float:left; background-color:#2196f3; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-right:10px;">
‚Üê Back
</button>

<button id="logoutBtn">Logout</button>

<h1>Track Attendance & Reports</h1>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
<div style="border:1px solid #ddd; padding:20px; border-radius:8px; background:#f9f9f9;">
<h3>Mark Member Attendance</h3>
<form id="attendanceForm">

<label>Member Name:</label>
<div style="position:relative;">
<input type="text" id="member_name" required placeholder="Type member name"
style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
<div id="suggestions"
style="position:absolute; top:100%; left:0; right:0; border:1px solid #ccc; background:white;
max-height:200px; overflow-y:auto; display:none; z-index:100;"></div>
</div>

<label>Date & Time (optional):</label>
<input type="datetime-local" id="date"
style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">

<button type="submit" style="background:#4CAF50; color:white; border:none; padding:10px; width:100%; border-radius:4px;">Mark Attendance</button>
<button type="button" id="createMemberBtn" style="background:#2196F3; color:white; border:none; padding:10px; width:100%; border-radius:4px; margin-top:10px;">Create New Member</button>

</form>
</div>

<div style="border:1px solid #ddd; padding:20px; border-radius:8px; background:#f9f9f9;">
<h3>Attendance Reports</h3>

<label>Select Month:</label>
<select id="monthSelect" style="width:100%; padding:10px;"></select>

<label>Select Year:</label>
<select id="yearSelect" style="width:100%; padding:10px;"></select>

</div>
</div>

<div style="margin-top:30px; border:1px solid #ddd; padding:20px; border-radius:8px;">
<h3 id="reportTitle">Attendance Summary</h3>
<p id="adminHint" style="display:none; color:#2196F3; font-weight:bold;">
Admins: Click any cell to edit attendance
</p>

<div style="overflow-x:auto;">
<table>
<thead id="attendanceHead"></thead>
<tbody id="attendanceTable"></tbody>
</table>
</div>
</div>

<script>

const token = localStorage.getItem('token');
if (!token) window.location.href = "index.html";

let role = '';
try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    role = payload.role;
} catch (e) {
    localStorage.removeItem('token');
    window.location.href = "index.html";
}

document.getElementById('logoutBtn').addEventListener('click',()=>{
    localStorage.removeItem('token');
    window.location.href="index.html";
});

function populateMonthYear(){
    const monthSel = document.getElementById('monthSelect');
    const yearSel = document.getElementById('yearSelect');
    const now = new Date();

    for(let m=0;m<12;m++){
        const opt=document.createElement('option');
        opt.value=m;
        opt.text=new Date(0,m).toLocaleString('default',{month:'long'});
        if(m===now.getMonth()) opt.selected=true;
        monthSel.appendChild(opt);
    }

    for(let y=now.getFullYear()-2;y<=now.getFullYear()+1;y++){
        const opt=document.createElement('option');
        opt.value=y;
        opt.text=y;
        if(y===now.getFullYear()) opt.selected=true;
        yearSel.appendChild(opt);
    }
}

async function loadAttendance(){
try{

const month=parseInt(document.getElementById('monthSelect').value);
const year=parseInt(document.getElementById('yearSelect').value);

const monthName=new Date(0,month).toLocaleString('default',{month:'long'});
document.getElementById('reportTitle').textContent=`Attendance Summary - ${monthName} ${year}`;

document.getElementById('adminHint').style.display=(role==='admin')?'block':'none';

const [mRes,aRes]=await Promise.all([
fetch('/api/members',{headers:{Authorization:`Bearer ${token}`}}),
fetch('/api/attendance',{headers:{Authorization:`Bearer ${token}`}})
]);

const members=await mRes.json();
const records=await aRes.json();

const sundays=[];
const start=new Date(year,month,1);
const end=new Date(year,month+1,0);

for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
if(d.getDay()===0) sundays.push(new Date(d));
}

const attendanceMap={};
records.forEach(r=>{
const dt=r.check_in||r.date||r.created_at;
if(!dt) return;
const datePart=dt.split('T')[0];
if(!attendanceMap[datePart]) attendanceMap[datePart]=new Set();
attendanceMap[datePart].add(String(r.member_id||r.memberId));
});

const thead=document.getElementById('attendanceHead');
thead.innerHTML='';
const headerRow=document.createElement('tr');
headerRow.innerHTML='<th>Member</th>'+sundays.map(s=>`<th>${s.toLocaleDateString()}</th>`).join('');
thead.appendChild(headerRow);

const tbody=document.getElementById('attendanceTable');
tbody.innerHTML='';

members.forEach(m=>{
const tr=document.createElement('tr');
let rowHtml=`<td>${m.name}</td>`;

sundays.forEach(s=>{
const yyyy=s.getFullYear();
const mm=String(s.getMonth()+1).padStart(2,'0');
const dd=String(s.getDate()).padStart(2,'0');
const key=`${yyyy}-${mm}-${dd}`;
const present=attendanceMap[key]&&attendanceMap[key].has(String(m.id));

if(role==='admin'){
rowHtml+=`<td class="clickable-cell" onclick="editAttendance(${m.id},'${key}',${present})">
${present?'<span style="color:green">Present</span>':'<span style="color:red">Absent</span>'}
</td>`;
}else{
rowHtml+=`<td>${present?'<span style="color:green">Present</span>':'<span style="color:red">Absent</span>'}</td>`;
}
});

tr.innerHTML=rowHtml;
tbody.appendChild(tr);
});

}catch(err){
console.error(err);
alert('Error loading attendance');
}
}

populateMonthYear();
document.getElementById('monthSelect').addEventListener('change',loadAttendance);
document.getElementById('yearSelect').addEventListener('change',loadAttendance);

loadAttendance();

</script>
</body>
</html>
